<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>내 프로젝트</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f6f9;
            margin: 0;
            padding: 0;
        }

        header {
            background-color: #4a90e2;
            padding: 1rem 2rem;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        select {
            padding: 0.4rem;
            border-radius: 6px;
            border: none;
        }

        button {
            background-color: white;
            color: #4a90e2;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        .container {
            padding: 2rem;
        }


        .filter-bar {
            background: white;
            padding: 1rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .project-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .plus-box {
            width: 150px;
            height: 150px;
            background: white;
            border: 2px solid #4a90e2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 30%;
        }

        .modal-content h2 {
            margin-top: 0;
        }

        .item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .item input {
            margin-right: 0.5rem;
            flex: 1;
        }

        .item button {
            margin-left: 0.2rem;
        }
    </style>
</head>
<body>

<!-- 메인 헤더 -->
<header>
    <div class="header-left">내 프로젝트</div>
    <div class="header-right">
        <span th:text="${memberName}" style="font-weight: bold;"></span> 님
        <form th:action="@{/project/{memberId}/state(memberId=${memberId})}" method="post">
            <select name="cud" onchange="this.form.submit()">
                <option value="JOIN">가입</option>
                <option value="DORMANT">휴면</option>
                <option value="WITHDRAWAL">탈퇴</option>
            </select>
        </form>
        <form th:action="@{/project/register}" method="get">
            <input type="hidden" name="memberId" th:value="${memberId}"/>
            <button type="submit">프로젝트 생성</button>
        </form>
        <form th:action="@{/logout}" method="post">
            <button type="submit">로그아웃</button>
        </form>
    </div>
</header>

<input type="hidden" id="projectId" th:value="${projectId}"/>
<div class="container">
    <div class="project-title" th:text="${projectTitle}">프로젝트 Title</div>

    <div class="filter-bar">
        <div class="filter-left">
            <label>태그: <select onclick="openModal('tagModal')">
                <option>전체</option>
            </select></label>
            <label>마일스톤: <select onclick="openModal('milestoneModal')">
                <option>전체</option>
            </select></label>
        </div>
    </div>

    <div class="plus-box" onclick="openModal('milestoneModal')">+</div>
</div>

<!-- 태그 모달 -->
<div id="tagModal" class="modal">
    <div class="modal-content">
        <h2>태그 관리</h2>
        <div id="tagList"></div>
        <button onclick="addTagInput()">+ 새 태그 추가</button>
        <button onclick="closeModal('tagModal')">닫기</button>
    </div>
</div>

<!-- 마일스톤 모달 -->
<div id="milestoneModal" class="modal">
    <div class="modal-content">
        <h2>마일스톤 관리</h2>
        <!-- 마일스톤 관리 코드는 이후 추가 -->
        <button onclick="closeModal('milestoneModal')">닫기</button>
    </div>
</div>

<script>
    function openModal(id) {
        document.getElementById(id).style.display = 'block';
        if (id === 'tagModal') {
            const projectId = document.getElementById('projectId').value;
            loadTags(projectId);
        }
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    function addTagInput() {
        const projectId = document.getElementById('projectId').value;
        const tagList = document.getElementById('tagList');

        const div = document.createElement('div');
        div.className = 'item';

        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = '새 태그 입력';

        const saveButton = document.createElement('button');
        saveButton.textContent = '저장';
        saveButton.onclick = function () {
            const tagName = input.value.trim();
            if (!tagName) {
                alert('태그 이름을 입력하세요.');
                return;
            }
            fetch(`/project/${projectId}/tag`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tagName })
            })
                .then(response => {
                    if (response.ok) {
                        loadTags(projectId);
                    } else {
                        loadTags(projectId);
                    }
                })
                .catch(error => {
                    console.error('태그 등록 실패:', error);
                    loadTags(projectId);
                });
        };

        const deleteButton = document.createElement('button');
        deleteButton.textContent = '삭제';
        deleteButton.onclick = function () {
            tagList.removeChild(div);
        };

        div.appendChild(input);
        div.appendChild(saveButton);
        div.appendChild(deleteButton);
        tagList.appendChild(div);
    }

    function loadTags(projectId) {
        fetch(`/project/${projectId}/tag`)
            .then(response => response.json())
            .then(tags => {
                const tagList = document.getElementById('tagList');
                tagList.innerHTML = '';

                if (tags.length === 0) {
                    tagList.innerHTML = '<div>등록된 태그가 없습니다.</div>';
                } else {
                    tags.forEach(tag => {
                        tagList.appendChild(createTagItem(projectId, tag));
                    });
                }
            })
            .catch(error => {
                console.error('태그 불러오기 실패:', error);
            });
    }

    function createTagItem(projectId, tag) {
        const div = document.createElement('div');
        div.className = 'item';

        const input = document.createElement('input');
        input.type = 'text';
        input.value = tag.tagName;
        input.disabled = true;

        const editButton = document.createElement('button');
        editButton.textContent = '수정';

        const saveButton = document.createElement('button');
        saveButton.textContent = '저장';
        saveButton.style.display = 'none'; // 처음에는 저장 버튼 숨김

        editButton.onclick = function () {
            input.disabled = false;
            editButton.style.display = 'none';
            saveButton.style.display = 'inline';
        };

        saveButton.onclick = function () {
            const newTagName = input.value.trim();
            if (!newTagName) {
                alert('태그 이름을 입력하세요.');
                return;
            }
            fetch('/project/' + projectId + '/tag/' + tag.tagId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tagName: newTagName })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('수정 실패');
                    }
                    alert('수정 완료');
                    input.disabled = true;
                    editButton.style.display = 'inline';
                    saveButton.style.display = 'none';
                    // 저장 후 목록을 다시 불러오지 않고 바로 상태만 갱신
                })
                .catch(error => {
                    console.error('태그 수정 실패:', error);
                    alert('수정 실패');
                });
        };

        const deleteButton = document.createElement('button');
        deleteButton.textContent = '삭제';
        deleteButton.onclick = function () {
            if (confirm('정말 삭제하시겠습니까?')) {
                fetch(`/project/${projectId}/tag/${tag.tagId}`, { method: 'DELETE' })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('삭제 실패');
                        }
                        alert('삭제 완료');
                        loadTags(projectId);
                    })
                    .catch(error => {
                        console.error('태그 삭제 실패:', error);
                        alert('삭제 실패');
                    });
            }
        };

        div.appendChild(input);
        div.appendChild(editButton);
        div.appendChild(saveButton);
        div.appendChild(deleteButton);

        return div;
    }

</script>

</body>
</html>